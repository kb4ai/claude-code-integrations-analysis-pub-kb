# CLI Integration Analysis: claude-flow
# Spec: specs/cli-integration.spec.yaml

project: "claude-flow"
cli_integration_detected: true

summary: |
  Spawns multiple Claude Code CLI instances via child_process.spawn() for parallel multi-agent
  orchestration. Uses stream-json for NDJSON output with stdoutâ†’stdin piping for stream chaining
  between agents. Phase-based execution with DAG dependency resolution.

invocations:

  - id: automation-executor-spawn
    description: "Primary spawn method for per-task Claude Code instances"

    reference:
      repository: "https://github.com/ruvnet/claude-flow"
      commit: "e82a79419c6a648a36de3529ab5d44a8a4d818a4"
      path: "v2/src/cli/simple-commands/automation-executor.js"
      lines: [229, 275]
      function: "spawnClaudeInstance"
      language: "javascript"

    command_pattern: "claude --print --output-format stream-json --verbose [--input-format stream-json] --dangerously-skip-permissions {prompt}"

    flags_used:
      - flag: "--print"
        value_type: "flag"
        purpose: "Headless mode for piped output"
        checklist_ref: "cli-flags.checklist.yaml#print-prompt"

      - flag: "--output-format"
        value_type: "enum"
        value_options: ["stream-json"]
        purpose: "Real-time streaming JSON output for parsing"
        checklist_ref: "cli-flags.checklist.yaml#output-format"

      - flag: "--verbose"
        value_type: "flag"
        purpose: "Required for stream-json output"
        checklist_ref: "cli-flags.checklist.yaml#verbose"

      - flag: "--input-format"
        value_type: "enum"
        value_options: ["stream-json"]
        purpose: "Accept chained input from previous agent (when stream chaining)"
        checklist_ref: "cli-flags.checklist.yaml#input-format"

      - flag: "--dangerously-skip-permissions"
        value_type: "flag"
        purpose: "Auto-approve all operations for automated workflows"
        checklist_ref: "cli-flags.checklist.yaml#dangerously-skip-permissions"

    snippet: |
      async spawnClaudeInstance(agent, prompt, options = {}) {
        const claudeArgs = [];
        if (this.options.nonInteractive) {
          claudeArgs.push('--print');
          if (this.options.outputFormat === 'stream-json') {
            claudeArgs.push('--output-format', 'stream-json');
            claudeArgs.push('--verbose');
            if (options.inputStream) {
              claudeArgs.push('--input-format', 'stream-json');
            }
          }
        }
        claudeArgs.push('--dangerously-skip-permissions');
        claudeArgs.push(prompt);

        const claudeProcess = spawn('claude', claudeArgs, {
          stdio: stdioConfig,
          shell: false,
        });

    environment_variables:
      - name: "CLAUDE_FLOW_CONFIG"
        purpose: "Config file path (default: claude-flow.config.json)"
      - name: "CLAUDE_FLOW_LOG_LEVEL"
        purpose: "Log level"
      - name: "ANTHROPIC_API_KEY"
        purpose: "API authentication"

    notes: |
      shell:false for security. Multiple Claude instances tracked in Map<agentId, process>.
      Phase-based execution: Promise.allSettled() for parallel within phases, sequential between phases.
      Default timeout: 1 hour (2 hours for ML workflows).

  - id: stream-chain-execution
    description: "Sequential stream chaining between Claude instances"

    reference:
      repository: "https://github.com/ruvnet/claude-flow"
      commit: "e82a79419c6a648a36de3529ab5d44a8a4d818a4"
      path: "v2/src/cli/simple-commands/stream-chain.js"
      lines: [49, 156]
      function: "executeStep"
      language: "javascript"

    command_pattern: "claude -p --output-format stream-json --verbose {prompt_with_previous_context}"

    snippet: |
      async function executeStep(prompt, previousContent, stepNum, totalSteps, flags) {
        let fullPrompt = prompt;
        if (previousContent) {
          fullPrompt = `Previous step output:\n${previousContent}\n\nNext step: ${prompt}`;
        }
        const args = ['-p'];
        args.push('--output-format', 'stream-json', '--verbose');
        args.push(fullPrompt);
        const claudeProcess = spawn('claude', args, {
          stdio: ['pipe', 'pipe', 'pipe'],
          env: process.env
        });

    notes: "Passes previous agent output as context prefix in prompt"

  - id: ndjson-content-extraction
    description: "Parses stream-json NDJSON output to extract text content"

    reference:
      repository: "https://github.com/ruvnet/claude-flow"
      commit: "e82a79419c6a648a36de3529ab5d44a8a4d818a4"
      path: "v2/src/cli/simple-commands/stream-chain.js"
      lines: [24, 44]
      function: "extractContentFromStream"
      language: "javascript"

    snippet: |
      function extractContentFromStream(streamOutput) {
        const lines = streamOutput.split('\n').filter(line => line.trim());
        let content = '';
        for (const line of lines) {
          try {
            const json = JSON.parse(line);
            if (json.type === 'assistant' && json.message && json.message.content) {
              for (const item of json.message.content) {
                if (item.type === 'text' && item.text) {
                  content += item.text;
                }
              }
            }
          } catch (e) { /* Skip non-JSON lines */ }
        }
        return content.trim();
      }

    notes: "Line-by-line JSON parsing; extracts text from assistant message content blocks"

flags_summary:
  "--print":
    used: true
    invocation_ids: ["automation-executor-spawn", "stream-chain-execution"]
    notes: "Used in non-interactive mode"
  "--output-format":
    used: true
    invocation_ids: ["automation-executor-spawn", "stream-chain-execution"]
    notes: "Always stream-json for NDJSON output"
  "--verbose":
    used: true
    invocation_ids: ["automation-executor-spawn", "stream-chain-execution"]
    notes: "Required for stream-json"
  "--input-format":
    used: true
    invocation_ids: ["automation-executor-spawn"]
    notes: "Used when chaining from previous agent output"
  "--dangerously-skip-permissions":
    used: true
    invocation_ids: ["automation-executor-spawn"]
    notes: "Always enabled for automated workflows"
  "-p":
    used: true
    invocation_ids: ["stream-chain-execution"]
    notes: "Prompt passed as final argument"
  "--session":
    used: false
    invocation_ids: []
    notes: "NOT used directly - custom session IDs for coordination"
  "--model":
    used: false
    invocation_ids: []
    notes: "NOT used - defaults to Claude Code's model"
  "--max-turns":
    used: false
    invocation_ids: []
    notes: "NOT used"
