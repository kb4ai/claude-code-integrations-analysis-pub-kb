# SDK Integration Analysis: claude-code-action
# Spec: specs/sdk-integration.spec.yaml

project: "claude-code-action"
sdk_integration_detected: true

summary: |
  Uses @anthropic-ai/claude-agent-sdk v0.2.36 as primary integration. The query() async iterator
  is the main entry point for Claude Code interactions. Supports model selection, tool restrictions,
  system prompts, and session management. Plugin installation uses CLI subprocess.

sdks_used:
  - name: "claude-agent-sdk-typescript"
    package: "@anthropic-ai/claude-agent-sdk"
    version_constraint: "0.2.36"
    import_reference:
      path: "base-action/src/run-claude-sdk.ts"
      lines: [4, 9]
      snippet: |
        import { query } from "@anthropic-ai/claude-agent-sdk";
        import type {
          SDKMessage,
          SDKResultMessage,
          SDKUserMessage,
        } from "@anthropic-ai/claude-agent-sdk";

sdk_usage:

  - id: query-async-iterator
    sdk: "claude-agent-sdk-typescript"
    pattern: "query-iterator"
    description: "Primary Claude Code interaction via query() async iterator"

    reference:
      repository: "https://github.com/anthropics/claude-code-action"
      commit: "db388438c199401cf36c143bb877ba3c3e6a9be5"
      path: "base-action/src/run-claude-sdk.ts"
      lines: [136, 244]
      function: "runClaudeWithSdk"
      language: "typescript"

    api_methods:
      - "query()"

    parameters:
      - name: "model"
        value_type: "string"
        purpose: "Model selection"
        example_value: "claude-sonnet-4-5-20250929"
      - name: "maxTurns"
        value_type: "integer"
        purpose: "Limit conversation turns"
        example_value: "25"
      - name: "allowedTools"
        value_type: "string[]"
        purpose: "Whitelist specific tools"
      - name: "disallowedTools"
        value_type: "string[]"
        purpose: "Blacklist specific tools"
      - name: "systemPrompt"
        value_type: "string"
        purpose: "Custom system prompt (preset type)"
      - name: "fallbackModel"
        value_type: "string"
        purpose: "Fallback model if primary unavailable"
      - name: "extraArgs"
        value_type: "Record<string, string | null>"
        purpose: "Additional CLI arguments parsed from claudeArgs, passed through to SDK"
      - name: "env"
        value_type: "Record<string, string | undefined>"
        purpose: "Environment variables for Claude process"
      - name: "settingSources"
        value_type: "SdkOptions['settingSources']"
        purpose: "Settings sources configuration (user, project, local)"

    snippet: |
      for await (const message of query({ prompt, options: sdkOptions })) {
        messages.push(message);

        const sanitized = sanitizeSdkOutput(message, showFullOutput);
        if (sanitized) {
          console.log(sanitized);
        }

        if (message.type === "result") {
          resultMessage = message as SDKResultMessage;
        }
      }

    notes: |
      Async iterator pattern - yields SDKMessage objects in real-time.
      Options built via parseSdkOptions() in base-action/src/parse-sdk-options.ts.
      Session ID extracted post-loop via messages.find() on system.init message.
      Supports both tag mode (@claude) and full agent mode.

    checklist_refs:
      - "sdk-features.checklist.yaml#agent-configuration"
      - "sdk-features.checklist.yaml#tool-registration"

  - id: plugin-installation-cli
    sdk: "claude-agent-sdk-typescript"
    pattern: "cli-subprocess"
    description: "Plugin installation via Claude CLI subprocess"

    reference:
      repository: "https://github.com/anthropics/claude-code-action"
      commit: "db388438c199401cf36c143bb877ba3c3e6a9be5"
      path: "base-action/src/install-plugins.ts"
      lines: [171, 182]
      function: "installPlugin"
      language: "typescript"

    api_methods:
      - "child_process.spawn"

    snippet: |
      async function installPlugin(
        pluginName: string,
        claudeExecutable: string,
      ): Promise<void> {
        console.log(`Installing plugin: ${pluginName}`);

        return executeClaudeCommand(
          claudeExecutable,
          ["plugin", "install", pluginName],
          `Failed to install plugin '${pluginName}'`,
        );
      }

    notes: |
      Hybrid approach: SDK for queries, CLI spawn for plugin management.
      Uses child_process.spawn (not execSync) via executeClaudeCommand helper.
      Also supports marketplace add via addMarketplace() (lines 191-202).
      Exported installPlugins() (lines 212-243) orchestrates marketplace + plugin setup.

  - id: session-id-extraction
    sdk: "claude-agent-sdk-typescript"
    pattern: "session-management"
    description: "Extracts session ID from system.init message"

    reference:
      repository: "https://github.com/anthropics/claude-code-action"
      commit: "db388438c199401cf36c143bb877ba3c3e6a9be5"
      path: "base-action/src/run-claude-sdk.ts"
      lines: [191, 198]
      function: "runClaudeWithSdk"
      language: "typescript"

    snippet: |
      // Extract session_id from system.init message
      const initMessage = messages.find(
        (m) => m.type === "system" && "subtype" in m && m.subtype === "init",
      );
      if (initMessage && "session_id" in initMessage && initMessage.session_id) {
        result.sessionId = initMessage.session_id as string;
        core.info(`Set session_id: ${result.sessionId}`);
      }

    notes: |
      Session ID extracted post-loop via Array.find() on collected messages.
      Exposed as GitHub Action output via core.setOutput in base-action/src/index.ts (line 52).
      Enables resume capability across GitHub Action runs.

# Claude Agents SDK specific features
agents_sdk_features:
  agent_configuration:
    model_selection: true
    system_prompt_customization: true
    tool_registration: true
    max_turns_config: true
    reference:
      path: "base-action/src/parse-sdk-options.ts"
      lines: [139, 271]

  tool_patterns:
    - tool_type: "allowed_tools"
      description: "Whitelist specific tools via allowedTools parameter"
    - tool_type: "disallowed_tools"
      description: "Blacklist specific tools via disallowedTools parameter"
    - tool_type: "mcp_servers"
      description: "Custom MCP servers for GitHub comment/CI integration"

  conversation_handling:
    session_persistence: true
    history_management: false
    context_windowing: false
    reference:
      path: "base-action/src/run-claude-sdk.ts"
      lines: [191, 198]

  auth_providers:
    - "Anthropic API (ANTHROPIC_API_KEY)"
    - "AWS Bedrock"
    - "Google Vertex AI"
    - "Foundry"

# Quick reference of patterns used
patterns_summary:
  query-iterator: true
  tool-use: true
  agent-create: false
  messages-stream: false
  session-management: true
  plugin-installation: true
  mcp-servers: true
