# CLI Integration Analysis: claude-code-mcp
# Spec: specs/cli-integration.spec.yaml

project: "claude-code-mcp"
cli_integration_detected: true

summary: |
  Spawns `claude` CLI per-request via Node.js child_process.spawn() with --dangerously-skip-permissions -p flags.
  Stateless execution with 30-minute timeout. Single MCP tool interface.

invocations:

  - id: mcp-tool-spawn
    description: "Spawns Claude Code CLI for each MCP tool invocation"

    reference:
      repository: "https://github.com/steipete/claude-code-mcp"
      commit: "24dfd389393cf35cc1390567bedda2d165756ef3"
      path: "src/server.ts"
      lines: [293, 300]
      function: "setupToolHandlers"
      class: "ClaudeCodeServer"
      language: "typescript"

    command_pattern: "claude --dangerously-skip-permissions -p {prompt}"

    flags_used:
      - flag: "--dangerously-skip-permissions"
        value_type: "flag"
        purpose: "Auto-approve all operations (required for non-interactive MCP context)"
        checklist_ref: "cli-flags.checklist.yaml#dangerously-skip-permissions"

      - flag: "-p"
        value_type: "string"
        purpose: "Pass prompt for non-interactive execution"
        checklist_ref: "cli-flags.checklist.yaml#print-prompt"

    snippet: |
      const claudeProcessArgs = ['--dangerously-skip-permissions', '-p', prompt];
      debugLog(`[Debug] Invoking Claude CLI: ${this.claudeCliPath} ${claudeProcessArgs.join(' ')}`);

      const { stdout, stderr } = await spawnAsync(
        this.claudeCliPath, // Run the Claude CLI directly
        claudeProcessArgs, // Pass the arguments
        { timeout: executionTimeoutMs, cwd: effectiveCwd }
      );

    environment_variables:
      - name: "CLAUDE_CLI_NAME"
        purpose: "Override Claude Code binary name/path"
      - name: "MCP_CLAUDE_DEBUG"
        purpose: "Enable debug logging"

    notes: |
      Stateless per-request spawning (contrast with Goose's persistent process).
      Binary resolution: CLAUDE_CLI_NAME env → ~/.claude/local/claude → PATH lookup.
      shell:false for security. 30-minute timeout.

  - id: binary-resolution
    description: "Resolves Claude Code binary location"

    reference:
      repository: "https://github.com/steipete/claude-code-mcp"
      commit: "24dfd389393cf35cc1390567bedda2d165756ef3"
      path: "src/server.ts"
      lines: [46, 83]
      function: "findClaudeCli"
      language: "typescript"

    snippet: |
      export function findClaudeCli(): string {
        debugLog('[Debug] Attempting to find Claude CLI...');

        // Check for custom CLI name from environment variable
        const customCliName = process.env.CLAUDE_CLI_NAME;
        if (customCliName) {
          debugLog(`[Debug] Using custom Claude CLI name from CLAUDE_CLI_NAME: ${customCliName}`);

          // If it's an absolute path, use it directly
          if (path.isAbsolute(customCliName)) {
            return customCliName;
          }

          // If it starts with ~ or ./, reject as relative paths are not allowed
          if (customCliName.startsWith('./') || customCliName.startsWith('../') || customCliName.includes('/')) {
            throw new Error(`Invalid CLAUDE_CLI_NAME: Relative paths are not allowed.`);
          }
        }

        const cliName = customCliName || 'claude';

        // Try local install path: ~/.claude/local/claude
        const userPath = join(homedir(), '.claude', 'local', 'claude');
        if (existsSync(userPath)) {
          return userPath;
        }

        // Fallback to CLI name (PATH lookup)
        return cliName;
      }

    notes: "Three-stage binary resolution with environment override"

# Summary of all flags used
flags_summary:
  "--dangerously-skip-permissions":
    used: true
    invocation_ids: ["mcp-tool-spawn"]
    notes: "Always enabled - required for non-interactive MCP context"
  "-p":
    used: true
    invocation_ids: ["mcp-tool-spawn"]
    notes: "Used for every invocation to pass prompt"
  "--session":
    used: false
    invocation_ids: []
    notes: "NOT used - stateless per-request execution"
  "--output-format":
    used: false
    invocation_ids: []
    notes: "NOT used - collects raw stdout/stderr text"
  "--model":
    used: false
    invocation_ids: []
    notes: "NOT used - uses whatever model Claude Code defaults to"
  "--system-prompt":
    used: false
    invocation_ids: []
    notes: "NOT used"
  "--max-turns":
    used: false
    invocation_ids: []
    notes: "NOT used"
  "--verbose":
    used: false
    invocation_ids: []
    notes: "NOT used"
